apiVersion: v1
kind: Secret
metadata:
  name: nacos-pg-login
  namespace: rc-36649931534c4217
type: Opaque
stringData:
  username: superusr
  password: super1u2s3r
---
apiVersion: v1
kind: Secret
metadata:
  name: nacos-admin-credentials
  namespace: rc-36649931534c4217
type: Opaque
stringData:
  username: nacos
  passwordHash: $2a$10$AwJocQohhujxzQkUYGgx/u60fn4RzCX1ghQBxmRv.QBaayCL7qcJG
---
apiVersion: v1
kind: Secret
metadata:
  name: nacos-identity
  namespace: rc-36649931534c4217
type: Opaque
stringData:
  identity_key: serverIdentity
  identity_value: security
---
# 用户自定义配置 ConfigMap - 包含用户可修改的高频参数
apiVersion: v1
kind: ConfigMap
metadata:
  name: nacos-user-config
  namespace: rc-36649931534c4217
data:
  user.properties: |
    # 用户可修改的参数
    nacos.core.auth.enabled=true
    nacos.naming.expireInstance=true
    nacos.config.retention.days=30
    nacos.remote.server.grpc.sdk.max-inbound-message-size=10485760
---
# 内置配置 ConfigMap - 包含核心参数，用户不应修改
apiVersion: v1
kind: ConfigMap
metadata:
  name: nacos-internal-config
  namespace: rc-36649931534c4217
data:
  internal.properties: |
    # 核心配置参数
    server.servlet.contextPath=${SERVER_SERVLET_CONTEXTPATH:/nacos}
    server.contextPath=/nacos
    server.port=${NACOS_APPLICATION_PORT:8848}
    server.tomcat.accesslog.max-days=30
    server.tomcat.accesslog.pattern=%h %l %u %t "%r" %s %b %D %{User-Agent}i %{Request-Source}i
    server.tomcat.accesslog.enabled=${TOMCAT_ACCESSLOG_ENABLED:false}
    server.error.include-message=ALWAYS
    server.tomcat.basedir=file:.

    # Database configuration
    spring.sql.init.platform=postgresql
    db.url.0=jdbc:postgresql://postgres-database-cluster-1.rc-36649931534c4217.svc.cluster.local:5432/postgres?tcpKeepAlive=true&reWriteBatchedInserts=true&ApplicationName=nacos_java
    db.user.0=superusr
    db.password.0=super1u2s3r
    db.pool.config.driverClassName=org.postgresql.Driver
    db.pool.config.connectionTestQuery=SELECT 1
    db.pool.config.initialSize=2
    db.pool.config.maxActive=10
    db.pool.config.maxWait=10000
    db.pool.config.minIdle=2
    db.pool.config.timeBetweenEvictionRunsMillis=60000
    db.pool.config.minEvictableIdleTimeMillis=300000
    db.pool.config.connectionTimeout=${DB_POOL_CONNECTION_TIMEOUT:30000}
    db.pool.config.validationTimeout=10000
    db.pool.config.maximumPoolSize=20
    db.pool.config.minimumIdle=2
    db.num=${MYSQL_DATABASE_NUM:1}

    # CMDB configuration
    nacos.cmdb.dumpTaskInterval=3600
    nacos.cmdb.eventTaskInterval=10
    nacos.cmdb.labelTaskInterval=300
    nacos.cmdb.loadDataAtStart=false

    # Auth configuration
    nacos.core.auth.enabled=true
    nacos.core.auth.plugin.nacos.token.expire.seconds=${NACOS_AUTH_TOKEN_EXPIRE_SECONDS:18000}
    nacos.core.auth.plugin.nacos.token.secret.key=${NACOS_AUTH_TOKEN:SecretKey012345678901234567890123456789012345678901234567890123456789}
    nacos.core.auth.caching.enabled=${NACOS_AUTH_CACHE_ENABLE:false}
    nacos.core.auth.enable.userAgentAuthWhite=${NACOS_AUTH_USER_AGENT_AUTH_WHITE_ENABLE:false}
    nacos.core.auth.server.identity.key=${NACOS_AUTH_IDENTITY_KEY:serverIdentity}
    nacos.core.auth.server.identity.value=${NACOS_AUTH_IDENTITY_VALUE:security}

    # Security configuration
    nacos.security.ignore.urls=${NACOS_SECURITY_IGNORE_URLS:/error,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/v1/auth/**,/v1/console/health/**,/v1/console/server/**}

    # Metrics configuration
    management.metrics.export.elastic.enabled=false
    management.metrics.export.influx.enabled=false

    # Naming configuration
    nacos.naming.distro.taskDispatchThreadCount=10
    nacos.naming.distro.taskDispatchPeriod=200
    nacos.naming.distro.batchSyncKeyCount=1000
    nacos.naming.distro.initDataRatio=0.9
    nacos.naming.distro.syncRetryDelay=5000
    nacos.naming.data.warmup=true
---
apiVersion: nacos.io/v1alpha1
kind: Nacos
metadata:
  name: nacos-cluster-example
  namespace: rc-36649931534c4217
spec:
  type: cluster
  image: docker.appnest.com:30010/paas-docker-dev/nacos/nacos-server:v2.4.3-pg
  replicas: 3
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 2
      memory: 2Gi
  volume:
    hostPath:
      path: /data/nacos/data
      type: DirectoryOrCreate
    keepAfterDeletion: true
  k8sWrapper:
    PodSpec:
      schedulerName: hostpath-scheduler
      containers:
      # 容器名称与 metadata.name 保持一致
      - name: nacos-cluster-example 
        readinessProbe:
          failureThreshold: 3
          tcpSocket:
            port: 8848
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        livenessProbe:
          tcpSocket:
            port: 8848
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 30
  # 配置管理：指定用户配置和内置配置的 ConfigMap 引用
  userConfigRef:
    name: nacos-user-config
    key: user.properties
  internalConfigRef:
    name: nacos-internal-config
    key: internal.properties
  # 最终合并后的 ConfigMap 名称（由 operator 自动创建和管理）
  finalConfigName: nacos-cluster-example-final-config
  postgres:
    host: "postgres-database-cluster-1.rc-36649931534c4217.svc.cluster.local"
    port: "5432"
    database: "postgres"
    credentialsSecretRef:
      name: "nacos-pg-login"
  pgInit:
    enabled: true
    timeoutSeconds: 20
  adminCredentialsSecretRef:
    name: nacos-admin-credentials
  identitySecretRef:
    name: nacos-identity
